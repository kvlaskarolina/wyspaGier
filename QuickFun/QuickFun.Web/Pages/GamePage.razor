@page "/game/{GameTypeString}"
@using QuickFun.Domain.Enums
@using QuickFun.Games
@using QuickFun.Games.Engines
@using QuickFun.Application.Interfaces
@using QuickFun.Games.Memory
@inject IGameFactory GameFactory
@inject IGameSessionService SessionService

<div class="game-layout">
    @if (CurrentGame == null)
    {
        <p>Ładowanie gry...</p>
    }
    else
    {
        <h1>@CurrentGame.Name</h1>

        @* SEKCJA DYNAMICZNA: Tutaj sprawdzamy, co wyprodukowała fabryka *@

        @if (CurrentGame is TicTacToeEngine ttt)
        {
            <div class="status">@ttt.Message</div>
            <div class="ttt-board">
                @for (int i = 0; i < 9; i++)
                {
                    int index = i;
                    <button class="cell" @onclick="() => HandleTicTacToeMove(ttt, index)" disabled="@ttt.IsGameOver">
                        @ttt.Board[i]
                    </button>
                }
            </div>
        }
        else if (CurrentGame is SnakeEngine snake)
        {
            @* Tutaj w przyszłości dodasz widok Snake'a *@
            <div class="snake-placeholder">
                Gra Snake w budowie! Twój wynik: @snake.Score
            </div>
        }
        else if (CurrentGame is MemoryEngine memory)
        {
            <div class="status">@memory.Message</div>
            <p>Punkty: @memory.Score</p>
            
            <div class="board-memory">
                @foreach (var card in memory.Cards)
                {
                    <button class="card @(card.IsRevealed || card.IsMatched ? "flipped" : "")"
                            @onclick="() => memory.HandleCardClick(card)"
                            disabled="@memory.IsGameOver">
                        
                        @if (card.IsRevealed || card.IsMatched)
                        {
                            <img src="@card.ImageUrl" style="width: 100%; height: 100%; object-fit: contain;" />
                        }
                        else
                        {
                            <span>?</span>
                        }
                    </button>
                }
            </div>
        }

        <div class="controls">
            <button class="btn" @onclick="Reset">Restart</button>
            <a href="/" class="btn btn-secondary">Powrót do menu</a>
        </div>
    }
</div>

@code {
    [Parameter] public string GameTypeString { get; set; }
    private IGameEngine CurrentGame { get; set; }

    // Ta metoda wykonuje się, gdy wejdziesz na stronę lub zmienisz parametr w URL
    protected override async Task OnParametersSetAsync() // Zmieniamy na Async!
    {
        if (Enum.TryParse<GameType>(GameTypeString, true, out var type))
        {
            CurrentGame = GameFactory.CreateGame(type);

            // Dodaj to: Jeśli to gra Memory, uruchom odliczanie
            if (CurrentGame is MemoryEngine memory)
            {
                await memory.Start(() => InvokeAsync(StateHasChanged));
            }
        }
    }

    private async Task HandleTicTacToeMove(TicTacToeEngine engine, int index)
    {
        engine.MakeMove(index);

    }

    private void Reset() => CurrentGame?.Reset();
}

<style>
    .board-memory {
        display: grid;
        grid-template-columns: repeat(4, 100px);
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
    }

    .card {
        width: 100px;
        height: 100px;
        background-color: #2c3e50;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .card.flipped {
        background-color: white;
        border: 2px solid #3498db;
    }
    .game-layout {
        text-align: center;
        max-width: 500px;
        margin: 2rem auto;
    }

    .ttt-board {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin: 1rem 0;
    }

    .cell {
        height: 100px;
        font-size: 2rem;
        background: white;
        border: 2px solid #333;
        border-radius: 8px;
    }

    .btn {
        padding: 10px 20px;
        cursor: pointer;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
    }

    .btn-secondary {
        background: #6c757d;
        text-decoration: none;
        margin-left: 10px;
        display: inline-block;
    }
</style>

